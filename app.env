ENVIRONMENT=development
DB_DRIVER=postgres
DB_SOURCE=postgresql://root:secret@localhost:5432/simple_bank?sslmode=disable
MIGRATION_URL=file://db/migration
HTTP_SERVER_ADDRESS=0.0.0.0:8080
GRPC_SERVER_ADDRESS=0.0.0.0:9090
TOKEN_SYMMETRIC_KEY=12345678901234567890123456789012
ACCESS_TOKEN_DURATION=15m
REFRESH_TOKEN_DURATION=24h
REDIS_ADDRESS=0.0.0.0:6379
EMAIL_SENDER_NAME=Simple Bank
EMAIL_SENDER_ADDRESS=simplebanktest@gmail.com
EMAIL_SENDER_PASSWORD=jekfcygyenvzekke

DECLARE
   l_xml    XMLTYPE := XMLTYPE('<employees>
                                   <employee>
                                      <id>1</id>
                                      <name>John Doe</name>
                                      <department>
                                         <name>Finance</name>
                                         <manager>Bob Smith</manager>
                                      </department>
                                      <salary>50000</salary>
                                   </employee>
                                   <employee>
                                      <id>2</id>
                                      <name>Jane Smith</name>
                                      <department>
                                         <name>Marketing</name>
                                         <manager>Sara Johnson</manager>
                                      </department>
                                      <salary>60000</salary>
                                   </employee>
                                </employees>');
   l_json   VARCHAR2(32767);
BEGIN
   SELECT JSON_ARRAYAGG(JSON_OBJECT(
              'id'         VALUE e.id,
              'name'       VALUE e.name,
              'departments' VALUE (
                                  SELECT JSON_ARRAYAGG(JSON_OBJECT(
                                              'name'    VALUE d.name,
                                              'manager' VALUE d.manager
                                           ))
                                  FROM   XMLTABLE('/department' PASSING e.department
                                             COLUMNS
                                                name     VARCHAR2(100) PATH 'name',
                                                manager  VARCHAR2(100) PATH 'manager') d
                               ),
              'salary'     VALUE e.salary
           ))
   INTO   l_json
   FROM   XMLTABLE('/employees/employee' PASSING l_xml
                    COLUMNS
                       id           NUMBER PATH 'id',
                       name         VARCHAR2(100) PATH 'name',
                       department   XMLTYPE PATH 'department',
                       salary       NUMBER PATH 'salary') e;

   DBMS_OUTPUT.PUT_LINE(l_json);
END;
